/********************************************************************************
 * cvsindex.C
 * 
 * (c) 2001 Amir Michail (amir@users.sourceforge.net)
 * modified by Andrew Yao (andrewy@users.sourceforge.net)
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * Usage:     cvsindex root0:package ...
 * 
 *           => processes $CVSDATA/root0/db/package.cmt,
 *                        $CVSDATA/root0/db/package.offset generated by cvsmap
 *
 *           => builds a directory 
 *                        $CVSDATA/root0/db/package.om' with quartz database inside
 * 
 * Warning:  it always deletes the directory $CVSDATA/root0/db/package.om if it 
 *           exists already.
 * 
 ********************************************************************************/

#include <om/om.h>
#include <fstream.h>
#include <stdio.h>
#include <stdlib.h>

#include "util.h"

#warning "should use omsee-0.4.1 or later"

void usage(char * prog_name);
const string database = "db";

bool get_root_package(const string & input, string & root, string & package) 
{
    list<string> root_package;
    split(input, ":", root_package);
    
    if (root_package.size() == 2) 
    {
        root = root_package.front();
        root_package.pop_front();
        package = root_package.front();
        return true;
    } else {
        return false;
    }
}

int main(int argc, char *argv[]) 
{
    if(argc < 2) {
        usage(argv[0]);
    }
    string cvsdata = get_cvsdata();

    for (int i = 1; i < argc; i++ ) {
        string root, package;
        get_root_package(argv[i], root, package);

        string package_path = cvsdata + "/" + root + "/db/" + package;

        // ----------------------------------------
        // no longer need this safety check
        // ----------------------------------------
        // assert( package_name != "." ); // safety checks
        // assert( package_name != ".." );
        // ----------------------------------------

        string file_cmt    = package_path + ".cmt";
        string file_offset = package_path + ".offset";
        string database_dir= package_path + ".om";

        cerr << "... removing directory " << database_dir << " (if it already exists)" << endl;
        system( ("rm -rf " + database_dir).c_str() );
        
        try {
            // ----------------------------------------
            // create database directory
            // ----------------------------------------
            system(("mkdir " + database_dir ).c_str());

            // ----------------------------------------
            // code which accesses Omsee
            // ----------------------------------------
            OmSettings db_parameters;
            db_parameters.set("backend", "quartz");
            db_parameters.set("quartz_dir", database_dir);
            db_parameters.set("database_create", true);
            OmWritableDatabase database(db_parameters); // open database 

            cerr << "... reading " << file_cmt << endl;

            int files = 0;
            // ----------------------------------------
            // no stop words, line granularity
            // ----------------------------------------
            Lines lines( "", root, package, file_cmt, file_offset, "line", false ); 
            string prev_file = "";
            while ( lines.ReadNextLine() ) {
                if ( lines.currentFile() != prev_file ) {
                    prev_file = lines.currentFile();
                    files++;
                }

                list<string> words = lines.getTermList();
                string data = lines.getData();
                // ----------------------------------------
                // we want to output something like:
                // 0.453 80 15 kdebase/konqueror:1.8 1.3 1.1
                // 0.453 is the score
                // 80 is the file number
                // 15 is the line number

                // so, along with each entry, we store the 
                // following associated string:
                // 80 15:1.8 1.3 1.1
                // ----------------------------------------
                OmDocument newdocument;
                int pos = 1;
                for( list<string>::iterator i = words.begin(); i != words.end(); i++ ) {
	  
                    string word = *i;
                    newdocument.add_posting(word, pos++); // term, position of term
                }
                newdocument.set_data(data);
                database.add_document(newdocument);
            }
            cerr << "... done!" << endl;
        }
        catch(OmError & error) {
            cerr << "OMSEE Exception: " << error.get_msg() << endl;
        } 
    }
}

void
usage(char * prog_name)
{
    cerr << "Usage: " << prog_name << " [Options] root_dir:pkg1 root_dir:pkg2 ..." << endl
         << endl
         << "Options:" << endl
         << "  -h                     print out this message" << endl
        ;
    exit(0);
}
