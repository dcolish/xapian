<?xml version="1.0"?>
<omindexer>
    <!-- First make split the filename down two paths -->
    <node type="omsplitter" id="splitfname">
        <input name="in" node="START" out_name="out"/></node>

    <!-- In the left path, read the file into memory -->
    <node type="omfilereader" id="readfile">
        <input name="filename" node="splitfname" out_name="left"/></node>
    <!-- Split the file into "words" -->
    <node type="omsplitonchars" id="wordsplit">
        <param name="wordchars" type="string" value="a-zA-Z"/>
        <input name="in" node="readfile" out_name="out"/></node>
    <!-- Duplicate the list of words -->
    <node type="omsplitter" id="dupwords">
        <input name="in" node="wordsplit" out_name="out"/></node>
    <!-- Left branch, separate capital words -->
    <node type="omregexfilter" id="capsonly">
        <param name="regex" type="string" value="^[A-Z]"/>
	<input name="in" node="dupwords" out_name="left"/></node>
    <node type="omtranslatelist" id="lowercaps">
        <param name="from" type="string" value="ABCDEFGHIJKLMNOPQRSTUVWXYZ"/>
        <param name="to" type="string" value="abcdefghijklmnopqrstuvwxyz"/>
	<input name="in" node="capsonly" out_name="out"/></node>
    <!-- Right branch, lower case everything... -->
    <node type="omtranslatelist" id="tolower">
        <param name="from" type="string" value="ABCDEFGHIJKLMNOPQRSTUVWXYZ"/>
        <param name="to" type="string" value="abcdefghijklmnopqrstuvwxyz"/>
	<input name="in" node="dupwords" out_name="right"/></node>
    <!-- ... and stem -->
    <node type="omstemmer" id="stem">
        <param name="language" type="string" value="english"/>
	<input name="in" node="tolower" out_name="out"/></node>
    <!-- Now merge the two lists of terms -->
    <node type="omlistconcat" id="terms">
        <input name="left" node="lowercaps" out_name="out"/>
	<input name="right" node="stem" out_name="out"/></node>

    <!-- convert the terms into a termlist -->
    <node type="omnewtermlist" id="maketermlist"></node>
    <node type="omtermlistadd" id="addtermlist">
        <input name="termlist" node="maketermlist" out_name="out"/>
	<input name="words" node="terms" out_name="out"/></node>

    <!-- Right branch from splitfname -->
    <!-- Split the filename again -->
    <node type="omsplitter" id="splitfname2">
        <input name="in" node="splitfname" out_name="right"/></node>
    <node type="omsplitter" id="splitfname3">
        <input name="in" node="splitfname2" out_name="right"/></node>
    <!-- extract the filename -->
    <node type="omregexreplace" id="filenameonly">
        <param name="regex" type="string" value="^(.*/)?([^/]+)$"/>
        <param name="replace_expr" type="string" value="\2"/>
	<input name="in" node="splitfname2" out_name="left"/></node>
    <!-- prefix the filename with "F" -->
    <node type="omprefix" id="prefixF">
        <param name="prefix" type="string" value="F"/>
	<input name="in" node="filenameonly" out_name="out"/></node>
    <!-- add into termlist -->
    <node type="omtermlistaddone" id="addfilename">
        <input name="termlist" node="addtermlist" out_name="out"/>
	<input name="words" node="prefixF" out_name="out"/></node>

    <!-- handle the keys: make a new keylist -->
    <node type="omnewkeylist" id="newkey"></node>
    <!-- split the filename into directory and name -->
    <node type="omregexmatch" id="splitdir">
        <param name="regex" type="string">\(.*/\)\?\([^/]*\)$</param>
    	<input name="in" node="splitfname3" out_name="left"/></node>
    <!-- Select the submatches, dropping the whole filename -->
    <node type="omselectitems" id="selectsubs">
        <param name="items" type="string" value="1 2"/>
	<input name="in" node="splitdir" out_name="out"/></node>

    <!-- Generate the key numbers -->
    <node type="ommakerange" id="keyrange">
        <param name="first" type="string" value="1"/>
        <param name="step" type="string" value="1"/>
        <param name="count" type="string" value="2"/></node>
    <!-- pair the key numbers with the key values -->
    <node type="ommakepairs" id="keypairs">
        <input name="left" node="keyrange" out_name="out"/>
        <input name="right" node="selectsubs" out_name="out"/></node>

    <!-- add the key to the list -->
    <node type="omkeylistadd" id="addkeys">
    	<input name="keylist" node="newkey" out_name="out"/>
	<input name="keys" node="keypairs" out_name="out"/></node>

    <!-- join everything into the final document -->
    <node type="ommakedoc" id="doc">
        <input name="terms" node="addfilename" out_name="out"/>
	<input name="data" node="splitfname3" out_name="right"/>
	<input name="keys" node="addkeys" out_name="out"/></node>

    <!-- specify the output -->
    <output node="doc" out_name="out"/>
</omindexer>
